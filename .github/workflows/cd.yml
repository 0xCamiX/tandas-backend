name: Deploy to EC2

on:
    push:
        branches: [main]
    pull_request:
        branches: [develop]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Create environment file
              run: |
                  cat > .env.prod << EOF
                  NODE_ENV=production
                  PORT=3000
                  DATABASE_URL=${{ secrets.DATABASE_URL }}
                  BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
                  BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }}
                  NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }}
                  DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
                  IMAGE_TAG=latest
                  EOF

            - name: Copy docker-compose to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "docker-compose.prod.yml"
                  target: "~/app/"
                  strip_components: 0

            - name: Copy environment file to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: ".env.prod"
                  target: "~/app/"
                  strip_components: 0

            - name: Copy deploy script to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "scripts/ec2/deploy.sh"
                  target: "~/app/"
                  strip_components: 2

            - name: Copy nginx configuration to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "nginx/*"
                  target: "~/app/"
                  strip_components: 0

            - name: Prepare files on EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      cd ~/app
                      mv docker-compose.prod.yml docker-compose.yml || true
                      mv .env.prod .env || true
                      chmod +x deploy.sh
                      echo "Files prepared successfully"

            - name: Deploy application on EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      cd ~/app
                      echo "Starting deployment..."
                      ./deploy.sh

            - name: Verify deployment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      echo "Waiting for service to be ready..."
                      sleep 15

                      echo "Checking health endpoint..."
                      if curl -f http://localhost:3000/health; then
                        echo "Deployment successful - Health check passed"
                        echo "Service is running correctly"
                      else
                        echo "Deployment failed - Health check failed"
                        echo "Checking container status..."
                        cd ~/app && docker compose ps
                        echo "Recent logs:"
                        cd ~/app && docker compose logs --tail=50
                        exit 1
                      fi

            - name: Show deployment info
              if: success()
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      echo "==========================="
                      echo "Deployment Status"
                      echo "==========================="
                      cd ~/app && docker compose ps
                      echo ""
                      echo "Health Check:"
                      curl -s http://localhost:3000/health | jq '.' || curl -s http://localhost:3000/health

            - name: Notify deployment status
              if: always()
              run: |
                  if [ ${{ job.status }} == 'success' ]; then
                    echo "Deployment to EC2 completed successfully!"
                    echo "Application is running at: http://${{ secrets.EC2_HOST }}:3000"
                  else
                    echo "Deployment to EC2 failed!"
                    echo "Check the logs above for details"
                    exit 1
                  fi
